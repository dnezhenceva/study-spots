<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Study Spots ‚Äî –º–µ—Å—Ç–æ</title>
  <script src="https://mapgl.2gis.com/api/js/v1"></script>
  <style>
    :root{
      --text:#0b1020; --muted:#51607a;
      --card: rgba(255,255,255,0.55); --stroke: rgba(15,23,42,0.10);
      --shadow: 0 18px 55px rgba(2,6,23,0.18);
      --radius:18px; --max: 980px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 12% 10%, rgba(37,99,235,0.22), transparent 60%),
        radial-gradient(900px 600px at 92% 25%, rgba(251,113,133,0.20), transparent 55%),
        radial-gradient(1000px 700px at 55% 105%, rgba(14,165,233,0.18), transparent 55%),
        linear-gradient(180deg, #ffffff 0%, #f3f7ff 40%, #f6f2ff 100%);
    }
    a{ color:inherit; text-decoration:none; }
    .container{ max-width:var(--max); margin:0 auto; padding: 18px; }
    .top{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      padding: 14px 0;
    }
    .btn{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.6);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
      backdrop-filter: blur(12px);
    }
    .btn.primary{
      border:none; color:#fff;
      background: linear-gradient(135deg,#1d4ed8,#0ea5e9);
      box-shadow: 0 14px 34px rgba(29,78,216,0.20);
    }
    .card{
      border: 1px solid rgba(255,255,255,0.55);
      background: var(--card);
      border-radius: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      padding: 16px;
      overflow:hidden;
    }
    h1{ margin:0; font-size: 22px; line-height:1.2; }
    .meta{ margin-top:8px; color:var(--muted); line-height:1.45; }
    .grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 12px;
    }
    .kv{ display:grid; grid-template-columns: 160px 1fr; gap: 8px; }
    .k{ color:var(--muted); }
    .v{ color:var(--text); }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.55);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12.5px;
      color: var(--muted);
      backdrop-filter: blur(12px);
    }
    #miniMap{
      height: 260px;
      border-radius: 16px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.55);
      box-shadow: 0 12px 28px rgba(2,6,23,0.12);
      margin-top: 10px;
    }
    .scorebar{
      margin-top:10px; height:10px; border-radius:999px;
      background: rgba(15,23,42,0.10); overflow:hidden;
    }
    .scorebar > div{ height:100%; border-radius:999px; width:0%; }
    .badgeScore{
      padding: 3px 8px; border-radius: 999px; font-size: 12px; font-weight: 700;
    }
    .badgeGood{ background: rgba(16,185,129,0.14); border:1px solid rgba(16,185,129,0.35); color:#0f5132; }
    .badgeMid{  background: rgba(245,158,11,0.14); border:1px solid rgba(245,158,11,0.35); color:#7a4b00; }
    .badgeBad{  background: rgba(239,68,68,0.12); border:1px solid rgba(239,68,68,0.30); color:#7a1c1c; }

    @media (max-width: 880px){
      .grid{ grid-template-columns: 1fr; }
      .kv{ grid-template-columns: 130px 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top">
      <div class="pill">Study Spots ¬∑ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –º–µ—Å—Ç–∞</div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn" href="/study-spots/public/map.html">‚Üê –ù–∞–∑–∞–¥ –∫ –∫–∞—Ä—Ç–µ</a>
        <button class="btn primary" id="btnCheckin">–Ø –∑–¥–µ—Å—å ‚úÖ</button>
        <button class="btn" id="btnCheckout">–Ø –≤—ã—à–ª–∞ üö™</button>
      </div>
    </div>

    <div class="card" id="card">
      <h1 id="title">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</h1>
      <div class="meta" id="address"></div>

      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
        <span class="pill" id="crowdPill">üë• –°–µ–π—á–∞—Å: ‚Äî</span>
        <span class="pill" id="ratingPill">–û—Ü–µ–Ω–∫–∞: ‚Äî</span>
        <span class="pill" id="typePill">–¢–∏–ø: ‚Äî</span>
      </div>

      <div style="margin-top:10px;">
        <div class="meta" style="font-weight:600;color:var(--text)">–ò–Ω–¥–µ–∫—Å —É–¥–æ–±—Å—Ç–≤–∞</div>
        <div style="margin-top:6px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <span class="badgeScore badgeMid" id="scoreLabel">‚Äî</span>
          <span class="pill">0‚Äì100 ¬∑ –≤—ã—à–µ ‚Äî –ª—É—á—à–µ</span>
          <span class="pill" id="scoreValue">‚Äî</span>
        </div>
        <div class="scorebar"><div id="scoreBar"></div></div>
      </div>

      <div class="grid">
        <div class="card" style="box-shadow:none; border-color: rgba(15,23,42,0.08); background: rgba(255,255,255,0.45);">
          <div class="meta" style="font-weight:700;color:var(--text);margin:0 0 10px 0;">–î–µ—Ç–∞–ª–∏</div>
          <div class="kv">
            <div class="k">–ê–¥—Ä–µ—Å</div><div class="v" id="addr2">‚Äî</div>
            <div class="k">–°–∞–π—Ç</div><div class="v" id="site">‚Äî</div>
            <div class="k">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</div><div class="v" id="hours">‚Äî</div>
          </div>
        </div>

        <div class="card" style="box-shadow:none; border-color: rgba(15,23,42,0.08); background: rgba(255,255,255,0.45);">
          <div class="meta" style="font-weight:700;color:var(--text);margin:0 0 10px 0;">–ù–∞ –∫–∞—Ä—Ç–µ</div>
          <div id="miniMap"></div>
          <div class="meta" style="margin-top:10px;">
            –ï—Å–ª–∏ –Ω–∞–∂–∞—Ç—å ‚Äú–Ø –∑–¥–µ—Å—å‚Äù, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å –∏–∑–º–µ–Ω–∏—Ç—Å—è –∏ –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const MAPGL_KEY = "b59a73f1-e4f4-425e-9a2f-a4be85d5737a";

    function qs(name){ return new URLSearchParams(location.search).get(name); }
    function safeSite(url){
      if (!url) return '';
      const u = String(url).trim();
      return /^https?:\/\//i.test(u) ? u : `https://${u}`;
    }
    function badge(type){ return type === 'library' ? 'üìö' : 'üèõÔ∏è'; }

    function scoreLabel(s){
      const n = Number(s);
      if (!Number.isFinite(n)) return {text:'–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö', cls:'badgeMid'};
      if (n >= 80) return {text:'–æ—Ç–ª–∏—á–Ω–æ', cls:'badgeGood'};
      if (n >= 60) return {text:'—Ö–æ—Ä–æ—à–æ', cls:'badgeMid'};
      return {text:'–ª—É—á—à–µ –∏—Å–∫–∞—Ç—å', cls:'badgeBad'};
    }
    function formatWorkingHours(raw){
      if (!raw) return '‚Äî';
      const s = String(raw);

      const re = /DayWeek:([^]+?)\s+WorkHours:([^]+?)(?=\s+DayWeek:|$)/g;
      const rows = [];
      let m;

      const mapDay = {
        '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫':'–ü–Ω',
        '–≤—Ç–æ—Ä–Ω–∏–∫':'–í—Ç',
        '—Å—Ä–µ–¥–∞':'–°—Ä',
        '—á–µ—Ç–≤–µ—Ä–≥':'–ß—Ç',
        '–ø—è—Ç–Ω–∏—Ü–∞':'–ü—Ç',
        '—Å—É–±–±–æ—Ç–∞':'–°–±',
        '–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ':'–í—Å'
      };

      while ((m = re.exec(s)) !== null){
        const day = m[1].trim().toLowerCase();
        let hrs = m[2].trim();

        hrs = hrs.replace('-', '‚Äì');

        const d = mapDay[day] || m[1].trim();
        rows.push(`${d} ‚Äî ${hrs}`);
      }

      if (!rows.length){
        return s
          .replaceAll('DayWeek:', '')
          .replaceAll('WorkHours:', '')
          .replace(/\s{2,}/g, ' ')
          .trim();
      }

      return rows.join('<br>');
    }

    function scoreBarStyle(s){
      const n = Math.max(0, Math.min(100, Number(s) || 0));
      let bg = 'linear-gradient(90deg, rgba(239,68,68,0.85), rgba(245,158,11,0.85))';
      if (n >= 80) bg = 'linear-gradient(90deg, rgba(16,185,129,0.85), rgba(14,165,233,0.85))';
      else if (n >= 60) bg = 'linear-gradient(90deg, rgba(245,158,11,0.90), rgba(14,165,233,0.70))';
      return {pct:n, bg};
    }

    function crowdText(ppl){
      const n = Number(ppl) || 0;
      if (n <= 2) return `–°–≤–æ–±–æ–¥–Ω–æ (${n} —á–µ–ª.)`;
      if (n <= 6) return `–£–º–µ—Ä–µ–Ω–Ω–æ (${n} —á–µ–ª.)`;
      return `–ú–Ω–æ–≥–æ–ª—é–¥–Ω–æ (${n} —á–µ–ª.)`;
    }

    const place_type = qs('type');
    const place_id = parseInt(qs('id'), 10);

    if (!place_type || !['library','museum'].includes(place_type) || !Number.isFinite(place_id) || place_id <= 0){
      document.getElementById('title').textContent = '–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞';
      document.getElementById('address').textContent = '–û—Ç–∫—Ä–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—É –º–µ—Å—Ç–∞ –∏–∑ –∫–∞—Ä—Ç—ã/—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.';
      throw new Error('Bad query params');
    }

    async function loadPlace(){
      const url = `/study-spots/api/places.php?place_type=${encodeURIComponent(place_type)}&place_id=${encodeURIComponent(place_id)}&limit=1`;
      const res = await fetch(url, { cache:'no-store' });
      const data = await res.json();

      if (!Array.isArray(data) || data.length === 0){
        document.getElementById('title').textContent = '–ú–µ—Å—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
        return;
      }

      const p = data[0];

      const title = p.CommonName ?? '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)';
      const addr = (p.DisplayAddress ?? p.ObjectAddress ?? '').toString();

      document.title = `${title} ‚Äî Study Spots`;

      document.getElementById('title').textContent = `${badge(p.Place_type)} ${title}`;
      document.getElementById('address').textContent = addr;

      document.getElementById('addr2').textContent = addr || '‚Äî';
      document.getElementById('hours').innerHTML = formatWorkingHours(p.WorkingHours);

      const site = p.WebSite ? safeSite(p.WebSite) : '';
      document.getElementById('site').innerHTML = site ? `<a href="${site}" target="_blank" rel="noopener">${site}</a>` : '‚Äî';

      document.getElementById('typePill').textContent = `–¢–∏–ø: ${p.Place_type === 'library' ? '–±–∏–±–ª–∏–æ—Ç–µ–∫–∞' : '–º—É–∑–µ–π'}`;
      document.getElementById('ratingPill').textContent = `–û—Ü–µ–Ω–∫–∞: ${p.Avg_rating ?? '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}`;
      document.getElementById('crowdPill').textContent = `üë• –°–µ–π—á–∞—Å: ${crowdText(p.Active_people)}`;

      const score = (p.Score !== null && p.Score !== undefined) ? Math.round(Number(p.Score)) : null;
      const lbl = scoreLabel(score);
      const sb = scoreBarStyle(score);

      const scoreLabelEl = document.getElementById('scoreLabel');
      scoreLabelEl.textContent = lbl.text;
      scoreLabelEl.className = `badgeScore ${lbl.cls}`;

      document.getElementById('scoreValue').textContent = (score === null || !Number.isFinite(score)) ? '–ò–Ω–¥–µ–∫—Å: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö' : `–ò–Ω–¥–µ–∫—Å: ${score}/100`;
      const bar = document.getElementById('scoreBar');
      bar.style.width = `${sb.pct}%`;
      bar.style.background = sb.bg;

      const lat = Number(p.Latitude);
      const lon = Number(p.Longitude);

      if (Number.isFinite(lat) && Number.isFinite(lon)){
        const el = document.getElementById('miniMap');
        el.innerHTML = '';

        const mini = new mapgl.Map('miniMap', {
          key: MAPGL_KEY,
          center: [lon, lat],
          zoom: 15
        });

        new mapgl.Marker(mini, { coordinates: [lon, lat] });
      } else {
        document.getElementById('miniMap').innerHTML = '<div class="meta">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</div>';
      }

      document.getElementById('btnCheckin').onclick = async () => {
        const fd = new FormData();
        fd.append('place_type', p.Place_type);
        fd.append('place_id', p.Place_id);
        fd.append('user_id', 1);
        const r = await fetch('/study-spots/api/checkin.php', { method:'POST', body: fd });
        const ans = await r.json();
        if (!ans.ok) return alert('–û—à–∏–±–∫–∞ check-in');
        alert('–û—Ç–º–µ—á–µ–Ω–æ ‚úÖ');
        await refreshAfter();
      };

      document.getElementById('btnCheckout').onclick = async () => {
        const fd = new FormData();
        fd.append('user_id', 1);
        const r = await fetch('/study-spots/api/checkout.php', { method:'POST', body: fd });
        const ans = await r.json();
        if (!ans.ok) return alert('–û—à–∏–±–∫–∞ checkout');
        alert('–û—Ç–º–µ—á–µ–Ω–æ: –≤—ã—à–ª–∞ ‚úÖ');
        await refreshAfter();
      };

      async function refreshAfter(){
        location.reload();
      }
    }
    loadPlace();
  </script>
</body>
</html>
